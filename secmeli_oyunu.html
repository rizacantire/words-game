<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SeÃ§meli Oyun</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS DeÄŸiÅŸkenleri ve Tema AyarlarÄ± (tahmin_oyunu.html ve dogru_yanlis_oyunu.html'den kopyalandÄ±) */
        :root {
            /* AydÄ±nlÄ±k Mod Renkleri */
            --bg-color: #f0f4f8; /* DÄ±ÅŸ arka plan */
            --container-bg: #ffffff; /* Ana iÃ§erik kutusu arka planÄ± */
            --text-color-dark: #1f2937; /* Koyu metin (gray-800) */
            --text-color-medium: #4b5563; /* Orta koyu metin (gray-700) */
            --text-color-light: #6b7280; /* AÃ§Ä±k metin (gray-600) */
            --border-color: #e5e7eb; /* KenarlÄ±k (gray-200) */
            --input-border: #d1d5db; /* Input kenarlÄ±ÄŸÄ± (gray-300) */
            --input-focus-border: #3b82f6; /* Input odak kenarlÄ±ÄŸÄ± (blue-500) */
            --blue-50-bg: #eff6ff; /* Mavi arka plan (blue-50) */
            --yellow-50-bg: #fffbeb; /* SarÄ± arka plan (yellow-50) */
            --red-100-bg: #fee2e2; /* KÄ±rmÄ±zÄ± arka plan (red-100) */
            --red-700-text: #b91c1c; /* KÄ±rmÄ±zÄ± metin (red-700) */
            --blue-100-bg: #dbeafe; /* Mavi arka plan (blue-100) */
            --blue-500-border: #3b82f6; /* Mavi kenarlÄ±k (blue-500) */
            --blue-700-text: #1d4ed8; /* Mavi metin (blue-700) */
            --green-600-text: #16a34a; /* YeÅŸil metin (green-600) */
            --red-600-text: #dc2626; /* KÄ±rmÄ±zÄ± metin (red-600) */
            --yellow-600-text: #eab308; /* SarÄ± metin (yellow-600) */
            --purple-500-bg: #a855f7; /* Mor arka plan (purple-500) */
            --purple-700-bg: #7e22ce; /* Koyu mor arka plan (purple-700) */
            --green-500-bg: #22c55e; /* YeÅŸil arka plan (green-500) */
            --green-700-bg: #15803d; /* Koyu yeÅŸil arka plan (green-700) */
            --gray-200-bg: #e5e7eb; /* Gri arka plan (gray-200) */
            --gray-300-bg: #d1d5db; /* Koyu gri arka plan (gray-300) */
            --gray-800-text: #1f2937; /* Koyu gri metin (gray-800) */
            --gray-100-bg: #f3f4f6; /* AÃ§Ä±k gri arka plan (gray-100) */
            --gray-500-text: #6b7280; /* Gri metin (gray-500) */
            --gray-50-bg: #f9fafb; /* Ã‡ok aÃ§Ä±k gri arka plan (gray-50) */
            --blue-600-text: #2563eb; /* Mavi metin (blue-600) */

            /* Primary Button Gradients */
            --primary-gradient-start: #6EE7B7;
            --primary-gradient-mid: #34D399;
            --primary-gradient-end: #10B981;
            --primary-gradient-hover-start: #34D399;
            --primary-gradient-hover-mid: #10B981;
            --primary-gradient-hover-end: #059669;

            /* SeÃ§enekler iÃ§in aydÄ±nlÄ±k mod renkleri */
            --option-bg-default: #e0f2fe; /* light blue-100 */
            --option-text-default: #2563eb; /* blue-600 */
            --option-bg-hover: #bfdbfe; /* blue-200 */
            --option-bg-correct: #a7f3d0; /* green-200 */
            --option-bg-incorrect: #fecaca; /* red-200 */
            --option-text-feedback: #1f2937; /* gray-800 */
        }

        .dark {
            /* KaranlÄ±k Mod Renkleri */
            --bg-color: #1a202c; /* Koyu gri dÄ±ÅŸ arka plan */
            --container-bg: #2d3748; /* Koyu iÃ§erik kutusu arka planÄ± */
            --text-color-dark: #e2e8f0; /* AÃ§Ä±k gri metin */
            --text-color-medium: #cbd5e0; /* Daha aÃ§Ä±k gri metin */
            --text-color-light: #a0aec0; /* En aÃ§Ä±k gri metin */
            --border-color: #4a5568; /* Koyu kenarlÄ±k */
            --input-border: #4a5568;
            --input-focus-border: #63b3ed; /* AÃ§Ä±k mavi odak kenarlÄ±ÄŸÄ± */
            --blue-50-bg: #2a4365; /* Koyu mavi-50 */
            --yellow-50-bg: #433e2e; /* Koyu sarÄ±-50 */
            --red-100-bg: #4a2d2d; /* Koyu kÄ±rmÄ±zÄ±-100 */
            --red-700-text: #ef4444; /* Parlak kÄ±rmÄ±zÄ± metin */
            --blue-100-bg: #2a4365; /* Koyu mavi-100 */
            --blue-500-border: #63b3ed; /* AÃ§Ä±k mavi kenarlÄ±k */
            --blue-700-text: #90cdf4; /* AÃ§Ä±k mavi metin */
            --green-600-text: #68d391; /* AÃ§Ä±k yeÅŸil metin */
            --red-600-text: #fc8181; /* AÃ§Ä±k kÄ±rmÄ±zÄ± metin */
            --yellow-600-text: #f6e05e; /* AÃ§Ä±k sarÄ± metin */
            --purple-500-bg: #9f7aea; /* AÃ§Ä±k mor */
            --purple-700-bg: #b794f4; /* Daha aÃ§Ä±k mor */
            --green-500-bg: #48bb78; /* AÃ§Ä±k yeÅŸil */
            --green-700-bg: #68d391; /* Daha aÃ§Ä±k yeÅŸil */
            --gray-200-bg: #4a5568; /* Koyu gri-200 */
            --gray-300-bg: #6b7280; /* Koyu gri-300 */
            --gray-800-text: #e2e8f0; /* AÃ§Ä±k gri metin */
            --gray-100-bg: #2d3748; /* Koyu gri-100 */
            --gray-500-text: #a0aec0; /* AÃ§Ä±k gri-500 */
            --gray-50-bg: #2d3748; /* Ã‡ok aÃ§Ä±k gri arka plan (gray-50) */
            --blue-600-text: #63b3ed; /* AÃ§Ä±k mavi metin */

            /* Primary Button Gradients for Dark Mode */
            --primary-gradient-start: #38a169;
            --primary-gradient-mid: #2f855a;
            --primary-gradient-end: #276749;
            --primary-gradient-hover-start: #2f855a;
            --primary-gradient-hover-mid: #276749;
            --primary-gradient-hover-end: #1c4532;

            /* SeÃ§enekler iÃ§in karanlÄ±k mod renkleri */
            --option-bg-default: #3a5375; /* custom dark blue */
            --option-text-default: #90cdf4; /* light blue */
            --option-bg-hover: #4a698c; /* darker custom blue */
            --option-bg-correct: #38a169; /* darker emerald */
            --option-bg-incorrect: #e53e3e; /* darker red */
            --option-text-feedback: #ffffff;
        }

        /* Genel HTML Element Stilleri */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color-dark);
        }
        .container {
            background-color: var(--container-bg);
            color: var(--text-color-dark);
        }
        /* Tailwind sÄ±nÄ±flarÄ±nÄ± CSS deÄŸiÅŸkenlerine baÄŸlama */
        .text-gray-800 { color: var(--text-color-dark); }
        .text-gray-700 { color: var(--text-color-medium); }
        .text-gray-600 { color: var(--text-color-light); }
        .border-gray-200 { border-color: var(--border-color); }
        .border-gray-300 { border-color: var(--input-border); }
        .focus\:border-blue-500:focus { border-color: var(--input-focus-border); }
        .bg-blue-50 { background-color: var(--blue-50-bg); }
        .bg-yellow-50 { background-color: var(--yellow-50-bg); }
        .bg-red-100 { background-color: var(--red-100-bg); }
        .text-red-700 { color: var(--red-700-text); }
        .bg-blue-100 { background-color: var(--blue-100-bg); }
        .border-blue-500 { border-color: var(--blue-500-border); }
        .text-blue-700 { color: var(--blue-700-text); }
        .text-green-600 { color: var(--green-600-text); }
        .text-red-600 { color: var(--red-600-text); }
        .text-yellow-600 { color: var(--yellow-600-text); }
        .bg-purple-500 { background-color: var(--purple-500-bg); }
        .hover\:bg-purple-700:hover { background-color: var(--purple-700-bg); }
        .bg-green-500 { background-color: var(--green-500-bg); }
        .hover\:bg-green-700:hover { background-color: var(--green-700-bg); }
        .bg-gray-200 { background-color: var(--gray-200-bg); }
        .hover\:bg-gray-300:hover { background-color: var(--gray-300-bg); }
        .text-gray-800 { color: var(--gray-800-text); }
        .bg-gray-100 { background-color: var(--gray-100-bg); }
        .text-gray-500 { color: var(--gray-500-text); }
        .bg-gray-50 { background-color: var(--gray-50-bg); }
        .text-blue-600 { color: var(--blue-600-text); }

        /* DiÄŸer Stil KurallarÄ± */
        .button-primary {
            background-image: linear-gradient(to right, var(--primary-gradient-start), var(--primary-gradient-mid), var(--primary-gradient-end));
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            color: white;
        }
        .button-primary:hover {
            background-image: linear-gradient(to right, var(--primary-gradient-hover-start), var(--primary-gradient-hover-mid), var(--primary-gradient-hover-end));
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        .button-secondary {
            background-color: var(--gray-200-bg);
            color: var(--text-color-medium);
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .button-secondary:hover {
            background-color: var(--gray-300-bg);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        /* SeÃ§enek KutularÄ± */
        .option-box {
            background-color: var(--option-bg-default);
            color: var(--option-text-default);
            font-weight: bold;
            padding: 1.5rem 1rem;
            border-radius: 0.75rem; /* rounded-xl */
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-size: 1.125rem; /* text-lg */
        }
        .option-box:hover:not(.disabled):not(.correct):not(.incorrect) {
            background-color: var(--option-bg-hover);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        .option-box.correct {
            background-color: var(--option-bg-correct);
            color: var(--option-text-feedback);
        }
        .option-box.incorrect {
            background-color: var(--option-bg-incorrect);
            color: var(--option-text-feedback);
        }
        .option-box.disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Modal Stilleri (TÃ¼m sayfalarda ortak olacak) */
        .modal {
            display: none; /* VarsayÄ±lan olarak gizli */
            position: fixed; /* EkranÄ± kapla */
            z-index: 1000; /* DiÄŸer her ÅŸeyin Ã¼zerinde */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* Ä°Ã§erik taÅŸarsa kaydÄ±rma */
            background-color: rgba(0,0,0,0.4); /* YarÄ± ÅŸeffaf siyah arka plan */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: var(--container-bg);
            color: var(--text-color-dark);
            margin: auto;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            width: 400px;
            text-align: center;
        }
        .close-button {
            color: var(--text-color-light);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: var(--text-color-dark);
            text-decoration: none;
        }

        /* KonumlandÄ±rma DÃ¼zeltmeleri */
        .absolute.top-4.left-4 { /* Ana MenÃ¼ butonu */
            top: 1rem;
            left: 1rem;
        }
        #user-info-display {
            top: 1rem;
            right: 1rem;
            z-index: 50;
        }
        /* Tema deÄŸiÅŸtirme butonu konumlandÄ±rmasÄ± tahmin_oyunu.html ile eÅŸleÅŸti */
        #theme-toggle {
            top: 1rem;
            left: calc(1rem + 100px); /* Ana MenÃ¼ butonunun saÄŸÄ±nda bir miktar boÅŸluk */
            z-index: 50;
        }

        /* Responsive ayarlamalar */
        @media (max-width: 768px) { /* Tablet ve mobil cihazlar iÃ§in */
            .absolute.top-4.left-4 {
                top: 0.5rem;
                left: 0.5rem;
                font-size: 0.65rem;
                padding: 0.25rem 0.5rem;
            }
            #user-info-display {
                top: 0.5rem;
                right: 0.5rem;
                font-size: 0.65rem;
                padding: 0.25rem 0.5rem;
            }
            #theme-toggle {
                top: 0.5rem;
                left: calc(0.5rem + 80px); /* Mobil iÃ§in daha kÃ¼Ã§Ã¼k boÅŸluk */
                padding: 0.1rem 0.2rem;
                font-size: 0.75rem;
            }
            h1 {
                font-size: 2.5rem;
            }
        }
        @media (max-width: 480px) { /* KÃ¼Ã§Ã¼k mobil cihazlar iÃ§in */
            .absolute.top-4.left-4 {
                top: 0.25rem;
                left: 0.25rem;
                font-size: 0.6rem;
                padding: 0.1rem 0.3rem;
            }
            #user-info-display {
                top: 0.25rem;
                right: 0.25rem;
                font-size: 0.6rem;
                padding: 0.1rem 0.3rem;
            }
            #theme-toggle {
                top: 0.25rem;
                left: calc(0.25rem + 70px); /* Daha da kÃ¼Ã§Ã¼k boÅŸluk */
                padding: 0.05rem 0.1rem;
                font-size: 0.6rem;
            }
            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="container p-8 rounded-xl shadow-lg flex flex-col items-center gap-6 relative">
        <!-- Her zaman gÃ¶rÃ¼nÃ¼r Ana MenÃ¼ butonu -->
        <a href="game_modes.html" class="absolute top-4 left-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg text-sm shadow-md transition duration-200 ease-in-out z-50">
            Mod SeÃ§imine DÃ¶n
        </a>

        <!-- KullanÄ±cÄ± Bilgisi ve Ã‡Ä±kÄ±ÅŸ Butonu (TÃ¼m sayfalarda ortak) -->
        <div id="user-info-display" class="absolute top-4 right-4 text-xs text-gray-600 bg-gray-100 px-3 py-1 rounded-md shadow-sm flex items-center gap-2">
            <span id="user-display-text">YÃ¼kleniyor...</span>
            <button id="sign-out-button" class="ml-2 px-2 py-1 bg-red-100 text-red-700 rounded-md hover:bg-red-200 text-xs hidden">Ã‡Ä±kÄ±ÅŸ Yap</button>
        </div>

        <!-- Tema DeÄŸiÅŸtirme Butonu -->
        <button id="theme-toggle" class="absolute top-4 left-28 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-3 rounded-full text-sm shadow-md transition duration-200 ease-in-out z-50" title="TemayÄ± DeÄŸiÅŸtir">
            <!-- SVG icon JS tarafÄ±ndan yÃ¼klenecek -->
        </button>

        <h1 class="text-4xl font-bold text-gray-800 mb-4 text-center">SeÃ§meli Oyun</h1>

        <!-- Oyun AlanÄ± -->
        <div id="game-section" class="w-full flex flex-col items-center gap-6 p-6">
            <div class="flex justify-between w-full text-lg font-medium text-gray-700">
                <span id="word-counter">Kelime: YÃ¼kleniyor...</span>
                <span id="score-display">Puan: 0</span>
            </div>
            <p id="question-word" class="text-6xl font-extrabold text-blue-600 my-8">YÃ¼kleniyor...</p>
            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-lg">
                <!-- SeÃ§enek kutularÄ± buraya JS ile yÃ¼klenecek -->
            </div>
            <div class="flex gap-4 mt-4">
                <button id="next-word-button" class="button-primary px-8 py-4 text-white font-bold rounded-xl text-xl hidden">Sonraki Kelime</button>
            </div>
            <p id="feedback-message" class="text-xl font-semibold mt-4 text-center min-h-[30px]"></p>
        </div>
    </div>

    <!-- SonuÃ§ ModalÄ± (Bu sayfaya Ã¶zel) -->
    <div id="result-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="window.closeModal('result-modal')">&times;</span>
            <h2 class="text-3xl font-bold text-gray-800 mb-4">Oyun Bitti! ðŸŽ‰</h2>
            <p id="final-score" class="text-2xl font-semibold text-blue-700 mb-6"></p>
            <p id="correct-count" class="text-xl font-semibold text-green-600 mb-2"></p>
            <p id="incorrect-count" class="text-xl font-semibold text-red-600 mb-2"></p>
            <div id="incorrect-words-list" class="text-left text-gray-700 mt-4 overflow-y-auto max-h-60 px-4"></div>
            <button class="button-primary px-6 py-3 text-white font-bold rounded-xl text-lg mt-6" onclick="window.restartGame()">Tekrar BaÅŸla</button>
            <a href="game_modes.html" class="button-secondary px-6 py-3 text-gray-800 font-bold rounded-xl text-lg mt-2 inline-block">Mod SeÃ§imine DÃ¶n</a>
        </div>
    </div>

    <!-- Modallar (TÃ¼m sayfalarda ortak olarak bulunmalÄ±) -->
    <div id="error-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="window.closeModal('error-modal')">&times;</span>
            <h2 class="text-3xl font-bold text-red-600 mb-4">Hata! ðŸš¨</h2>
            <p id="error-message" class="text-lg text-gray-700 mb-6"></p>
            <button class="button-secondary px-6 py-3 text-gray-800 font-bold rounded-xl text-lg" onclick="window.closeModal('error-modal')">Tamam</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4" id="confirm-modal-title">Onay Gerekli</h2>
            <p id="confirm-message" class="text-lg text-gray-700 mb-6"></p>
            <div id="confirm-details-list" class="text-left text-gray-700 mb-6 max-h-48 overflow-y-auto hidden">
                <!-- Detaylar buraya yÃ¼klenecek -->
            </div>
            <div class="flex justify-center gap-4">
                <button id="confirm-yes-button" class="button-primary px-6 py-3 text-white font-bold rounded-lg">Evet</button>
                <button id="confirm-no-button" class="button-secondary px-6 py-3 text-gray-800 font-bold rounded-lg">HayÄ±r</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db, userId, wordsCollectionRef, onSnapshot, query, capitalizeFirstLetter, showModal, closeModal, displayError, showConfirmModal, signOut, setTheme, toggleTheme } from './shared.js';

        // UI Elementleri
        const signOutButton = document.getElementById('sign-out-button');
        const questionWordDisplay = document.getElementById('question-word');
        const optionsContainer = document.getElementById('options-container');
        const nextWordButton = document.getElementById('next-word-button');
        const feedbackMessage = document.getElementById('feedback-message');
        const wordCounter = document.getElementById('word-counter');
        const scoreDisplay = document.getElementById('score-display');
        const resultModal = document.getElementById('result-modal');
        const finalScoreDisplay = document.getElementById('final-score');
        const correctCountDisplay = document.getElementById('correct-count');
        const incorrectCountDisplay = document.getElementById('incorrect-count');
        const incorrectWordsListDiv = document.getElementById('incorrect-words-list');
        const themeToggleButton = document.getElementById('theme-toggle');

        // Oyun deÄŸiÅŸkenleri
        let allWords = []; // KullanÄ±cÄ±nÄ±n tÃ¼m kelimeleri
        let wordsToGuess = []; // Mevcut oyunda sorulacak kelimeler
        let currentWordIndex = 0;
        let score = 0;
        let correctAnswersCount = 0;
        let incorrectAnswersCount = 0;
        let incorrectlyGuessedWords = [];
        let gameWordCount = 0;
        let gameDirection = 'italiantoturkish';
        let gameCategories = [];

        // Window objesine ortak fonksiyonlarÄ± ekle
        window.showModal = showModal;
        window.closeModal = closeModal;
        window.displayError = displayError;
        window.showConfirmModal = showConfirmModal;
        window.setTheme = setTheme;
        window.toggleTheme = toggleTheme;

        // --- Ã‡Ä±kÄ±ÅŸ Yapma ---
        signOutButton.addEventListener('click', async () => {
            showConfirmModal("Oturumu kapatmak istediÄŸinizden emin misiniz?", async (confirmed) => {
                if (confirmed) {
                    try {
                        await signOut(auth);
                        console.log("Oturum kapatÄ±ldÄ±.");
                        window.location.href = 'index.html';
                    } catch (error) {
                        console.error("Ã‡Ä±kÄ±ÅŸ yapma hatasÄ±:", error);
                        displayError("Ã‡Ä±kÄ±ÅŸ yapÄ±lÄ±rken bir hata oluÅŸtu: " + error.message);
                    }
                }
            });
        });

        // URL parametrelerini al ve oyun ayarlarÄ±nÄ± yap
        function getGameParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            gameWordCount = parseInt(urlParams.get('numWords') || '20', 10);
            gameDirection = urlParams.get('gameDirection') || 'italiantoturkish';
            gameCategories = urlParams.get('categories') ? urlParams.get('categories').split(',') : ['TÃ¼mÃ¼'];
            console.log("Oyun Parametreleri:", { gameWordCount, gameDirection, gameCategories });
        }

        // Firebase'den kelimeleri dinle ve oyunu baÅŸlat
        function setupWordsListenerAndStartGame() {
            if (!userId) {
                console.log("KullanÄ±cÄ± kimliÄŸi mevcut deÄŸil, kelimeler dinlenemiyor.");
                displayError("Oyun oynamak iÃ§in giriÅŸ yapmalÄ±sÄ±nÄ±z.");
                return;
            }

            onSnapshot(query(wordsCollectionRef), (snapshot) => {
                console.log("Firestore snapshot received in secmeli_oyunu.html. Updating word list.");
                const wordsFromDb = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    wordsFromDb.push({ id: doc.id, ...data });
                });
                allWords = wordsFromDb.sort((a, b) => (a.timestamp?.toDate() || 0) - (b.timestamp?.toDate() || 0));

                const filteredWords = getFilteredWords();
                console.log("FiltrelenmiÅŸ kelime sayÄ±sÄ±:", filteredWords.length);

                // SeÃ§meli oyun iÃ§in en az 4 kelimeye ihtiyacÄ±mÄ±z var (1 doÄŸru, 3 yanlÄ±ÅŸ seÃ§enek iÃ§in)
                if (filteredWords.length < 4 || filteredWords.length < gameWordCount) {
                    displayError(`SeÃ§meli oyun iÃ§in yeterli kelime bulunamadÄ±. SeÃ§ili kriterlere gÃ¶re en az 4 kelimeye ve seÃ§ilen oyun kelime sayÄ±sÄ±na (${gameWordCount}) ihtiyacÄ±nÄ±z var. Sadece ${filteredWords.length} kelime var. LÃ¼tfen Mod SeÃ§imine dÃ¶nÃ¼p ayarlarÄ± gÃ¼ncelleyin.`);
                    questionWordDisplay.textContent = "Yetersiz kelime!";
                    nextWordButton.disabled = true;
                    optionsContainer.innerHTML = ''; // SeÃ§enekleri temizle
                    return;
                }

                startGame(filteredWords);

            }, (error) => {
                console.error("Firebase kelimeleri dinlenirken hata oluÅŸtu (secmeli_oyunu.html): ", error);
                displayError("VeritabanÄ± baÄŸlantÄ±sÄ±nda hata: " + error.message);
            });
        }

        // SeÃ§ili kategorilere gÃ¶re kelimeleri filtreleyen yardÄ±mcÄ± fonksiyon
        function getFilteredWords() {
            if (gameCategories.includes('TÃ¼mÃ¼') || gameCategories.length === 0) {
                return allWords;
            }
            return allWords.filter(word =>
                word.type && gameCategories.includes(capitalizeFirstLetter(word.type, 'tr-TR'))
            );
        }

        // Oyunun dahili durumunu sÄ±fÄ±rlayan fonksiyon
        function resetGameInternal() {
            currentWordIndex = 0;
            score = 0;
            correctAnswersCount = 0;
            incorrectAnswersCount = 0;
            feedbackMessage.textContent = '';
            nextWordButton.classList.add('hidden');
            scoreDisplay.textContent = `Puan: 0`;
            optionsContainer.innerHTML = ''; // SeÃ§enekleri temizle
        }

        // Oyunu yeniden baÅŸlatan fonksiyon (modaldan Ã§aÄŸrÄ±lÄ±r)
        window.restartGame = function() {
            window.closeModal('result-modal');
            resetGameInternal();
            incorrectlyGuessedWords = [];
            startGame(getFilteredWords()); // Yeniden baÅŸlatÄ±rken filtrelenmiÅŸ kelimeleri kullan
        }

        // Yeni oyunu baÅŸlatan ana fonksiyon (rastgele kelimeleri seÃ§er)
        function startGame(words) {
            const shuffledWords = [...words].sort(() => 0.5 - Math.random());
            wordsToGuess = shuffledWords.slice(0, gameWordCount);
            console.log("Oyun baÅŸlatÄ±ldÄ±. Sorulacak kelimeler:", wordsToGuess.length);
            displayCurrentWord();
        }

        // Mevcut kelimeyi ve seÃ§enekleri ekranda gÃ¶steren fonksiyon
        function displayCurrentWord() {
            if (currentWordIndex < wordsToGuess.length) {
                const currentWord = wordsToGuess[currentWordIndex];
                let questionText = "";
                let correctAnswer = "";

                if (gameDirection === 'italiantoturkish') {
                    questionText = currentWord.italian;
                    correctAnswer = currentWord.turkish;
                } else {
                    questionText = currentWord.turkish;
                    correctAnswer = currentWord.italian;
                }

                questionWordDisplay.textContent = questionText;
                feedbackMessage.textContent = '';
                nextWordButton.classList.add('hidden');
                wordCounter.textContent = `Kelime: ${currentWordIndex + 1}/${gameWordCount}`;

                generateOptions(currentWord, correctAnswer);

            } else {
                endGame();
            }
        }

        // SeÃ§enekleri oluÅŸturan fonksiyon
        function generateOptions(currentWord, correctAnswer) {
            optionsContainer.innerHTML = ''; // Ã–nceki seÃ§enekleri temizle

            const allPossibleAnswers = allWords.map(word => gameDirection === 'italiantoturkish' ? word.turkish : word.italian);
            const options = new Set();
            options.add(correctAnswer); // DoÄŸru cevabÄ± ekle

            // YanlÄ±ÅŸ cevaplarÄ± ekle
            while (options.size < 4) {
                const randomIndex = Math.floor(Math.random() * allPossibleAnswers.length);
                const randomAnswer = allPossibleAnswers[randomIndex];

                // DoÄŸru cevap veya zaten eklenmiÅŸ bir seÃ§enek deÄŸilse ekle
                if (!options.has(randomAnswer) && randomAnswer.localeCompare(correctAnswer, undefined, { sensitivity: 'base' }) !== 0) {
                    options.add(randomAnswer);
                }
            }

            // SeÃ§enekleri karÄ±ÅŸtÄ±r
            const shuffledOptions = Array.from(options).sort(() => 0.5 - Math.random());

            shuffledOptions.forEach(optionText => {
                const optionBox = document.createElement('div');
                optionBox.textContent = capitalizeFirstLetter(optionText, gameDirection === 'italiantoturkish' ? 'tr-TR' : 'it-IT');
                optionBox.className = 'option-box';
                optionBox.dataset.answer = optionText;
                optionBox.addEventListener('click', () => checkAnswer(optionBox, currentWord, correctAnswer));
                optionsContainer.appendChild(optionBox);
            });
        }

        // CevabÄ± kontrol eden fonksiyon
        function checkAnswer(selectedBox, currentWord, correctAnswer) {
            const selectedAnswer = selectedBox.dataset.answer;
            const allOptionBoxes = optionsContainer.querySelectorAll('.option-box');

            // TÃ¼m kutularÄ± devre dÄ±ÅŸÄ± bÄ±rak
            allOptionBoxes.forEach(box => {
                box.classList.add('disabled');
            });

            let askedWord = "";
            if (gameDirection === 'italiantoturkish') {
                askedWord = currentWord.italian;
            } else {
                askedWord = currentWord.turkish;
            }

            if (selectedAnswer.localeCompare(correctAnswer, undefined, { sensitivity: 'base' }) === 0) {
                feedbackMessage.textContent = "DoÄŸru bildiniz! ðŸŽ‰";
                feedbackMessage.className = "text-xl font-semibold mt-4 text-green-600 min-h-[30px]";
                selectedBox.classList.add('correct');
                score++;
                correctAnswersCount++;
            } else {
                feedbackMessage.textContent = `YanlÄ±ÅŸ! DoÄŸru cevap: "${capitalizeFirstLetter(correctAnswer, gameDirection === 'italiantoturkish' ? 'tr-TR' : 'it-IT')}"`;
                feedbackMessage.className = "text-xl font-semibold mt-4 text-red-600 min-h-[30px]";
                selectedBox.classList.add('incorrect');
                incorrectAnswersCount++;
                incorrectlyGuessedWords.push({
                    asked: askedWord,
                    correct: correctAnswer,
                    userGuess: selectedAnswer,
                    direction: gameDirection
                });

                // DoÄŸru cevabÄ± iÅŸaretle
                allOptionBoxes.forEach(box => {
                    if (box.dataset.answer.localeCompare(correctAnswer, undefined, { sensitivity: 'base' }) === 0) {
                        box.classList.add('correct');
                    }
                });
            }
            scoreDisplay.textContent = `Puan: ${score}`;
            nextWordButton.classList.remove('hidden');
        }

        // Sonraki kelimeye geÃ§en fonksiyon
        nextWordButton.addEventListener('click', () => {
            currentWordIndex++;
            displayCurrentWord();
        });

        // Oyun bittiÄŸinde Ã§alÄ±ÅŸan fonksiyon
        function endGame() {
            finalScoreDisplay.textContent = `Toplamda ${gameWordCount} kelimeden ${score} doÄŸru cevap verdiniz!`;
            correctCountDisplay.textContent = `DoÄŸru: ${correctAnswersCount}`;
            incorrectCountDisplay.textContent = `YanlÄ±ÅŸ: ${incorrectAnswersCount}`;

            incorrectWordsListDiv.innerHTML = '';

            if (incorrectlyGuessedWords.length > 0) {
                const title = document.createElement('h3');
                title.className = 'text-xl font-semibold text-gray-800 mb-2 mt-4';
                title.textContent = 'YanlÄ±ÅŸ Bildikleriniz:';
                incorrectWordsListDiv.appendChild(title);

                const ul = document.createElement('ul');
                ul.className = 'list-disc list-inside text-left mx-auto max-w-xs';
                incorrectlyGuessedWords.forEach(item => {
                    const li = document.createElement('li');
                    let askedLang = item.direction === 'italiantoturkish' ? "Ä°talyanca" : "TÃ¼rkÃ§e";
                    let correctLang = item.direction === 'italiantoturkish' ? "TÃ¼rkÃ§e" : "Ä°talyanca";

                    li.innerHTML = `<span class="font-medium">${askedLang}: "${item.asked}"</span><br> DoÄŸru ${correctLang}: "<span class="text-green-600">${item.correct}</span>" (Sizin tahmininiz: "${item.userGuess}")`;
                    ul.appendChild(li);
                });
                incorrectWordsListDiv.appendChild(ul);
            } else {
                const congrats = document.createElement('p');
                congrats.className = 'text-lg text-green-700 mt-4';
                congrats.textContent = 'Tebrikler! TÃ¼m kelimeleri doÄŸru bildiniz!';
                incorrectWordsListDiv.appendChild(congrats);
            }

            window.showModal('result-modal');
        }

        // Tema butonuna olay dinleyici ekle
        if (themeToggleButton) {
            themeToggleButton.addEventListener('click', toggleTheme);
        }

        // Sayfa yÃ¼klendiÄŸinde
        document.addEventListener('DOMContentLoaded', () => {
            getGameParameters(); // URL'den oyun parametrelerini al
            // Tema ayarÄ±nÄ± sayfa yÃ¼klendiÄŸinde uygula
            setTheme(localStorage.getItem('theme') || 'light');
            // Tema deÄŸiÅŸtirme butonu ikonunu ayarla
            if (themeToggleButton) {
                if (localStorage.getItem('theme') === 'dark') {
                    themeToggleButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.364l-1.591 1.591M21 12h-2.25m-.364 6.364l-1.591-1.591M12 18.75V21m-6.364-.364l1.591-1.591M3 12H5.25m-.364-6.364l1.591 1.591M12 12.75a.75.75 0 110-1.5.75.75 0 010 1.5z" /></svg>'; // GÃ¼neÅŸ ikonu
                } else {
                    themeToggleButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0112 21.75c-4.552 0-8.448-2.97-9.752-7.148A9.716 9.716 0 0112 2.25c4.552 0 8.448 2.97 9.752 7.148z" /></svg>'; // Ay ikonu
                }
            }

            auth.onAuthStateChanged((user) => {
                if (user) {
                    setTimeout(() => {
                        if (wordsCollectionRef) {
                            setupWordsListenerAndStartGame();
                        } else {
                            console.warn("wordsCollectionRef hala null, tekrar denenecek.");
                            displayError("VeritabanÄ± baÄŸlantÄ±sÄ± kuruluyor... LÃ¼tfen sayfayÄ± yenileyin.");
                        }
                    }, 500);
                } else {
                    displayError("Oyun oynamak iÃ§in giriÅŸ yapmalÄ±sÄ±nÄ±z. Ana sayfaya yÃ¶nlendiriliyorsunuz.");
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 3000);
                }
            });
        });
    </script>
</body>
</html>
